# 后置质控统计页面重新设计

## 设计背景

原页面按规则维度展示机构错误列表，现需要重新设计为：
1. 规则详情区：展示每条规则的错误数据列表（不是机构列表）
2. 机构汇总区：展示所有错误机构的汇总列表

## 需求确认

1. **错误原因来源**：从 `DRUG_QC_CONDITION_GROUP` 表的 `error_message_template` 字段获取，参考前置质控的错误原因显示方式
2. **规则详情区数据**：每条规则下显示该规则检测出错误的所有机构
3. **查看错误弹框**：
   - 规则详情区：显示该机构在该规则下的具体错误数据行（整行数据+错误原因），不使用 `QcErrorGroupedDialog`
   - 机构汇总区：显示该机构的所有错误，按规则分组，使用 `QcErrorGroupedDialog`
4. **机构汇总区操作**：添加"退回"功能
5. **数据加载**：Redis中没有数据时使用懒加载从数据库查询

## 页面结构

### 1. 顶部统计卡片
- 后置质控规则数
- 错误机构数（去重）
- 建议退回机构数

### 2. 阈值提示（醒目显示）
```
⚠️ 建议退回阈值：二三级医院错误率 ≥ 5%，基层医院错误率 ≥ 55%
```

### 3. 规则详情区（折叠面板）

每条规则展示：
- 规则编码、名称、描述
- 错误记录数统计

错误数据列表（虚拟列表）：
| 序号 | 机构名称 | 等级 | 错误信息 | 错误原因 | 错误记录数 | 总记录数 | 错误率 | 操作 |
|------|---------|------|---------|---------|-----------|---------|--------|------|
| 1    | XX医院  | 三级 | ...     | ...     | 10        | 1000    | 1.0%   | 查看错误 |

**字段说明**：
- **等级**：从 `HOSPITAL_LEVEL_J` 字段计算
  - "32" → "三级二等"
  - "31" → "三级一等"
  - "22" → "二级二等"
  - 其他 → "基层"
- **错误原因**：详细说明，如"药品价格（金额/数量）超过参考价格最高价×100倍，参考价格为XX元"
- **错误率**：该机构在该规则下的错误率 = 错误记录数 / 总记录数 × 100%
- **操作**：查看该机构在该规则下的具体错误数据

**移除字段**：
- ❌ 机构代码
- ❌ 是否建议退回
- ❌ 建议退回原因

### 4. 机构汇总区（底部）

标题：**错误机构汇总列表**

表格（虚拟列表）：
| 序号 | 机构名称 | 等级 | 总记录数 | 错误记录数 | 错误率 | 是否建议退回 | 操作 |
|------|---------|------|---------|-----------|--------|-------------|------|
| 1    | XX医院  | 三级 | 10000   | 500       | 5.0%   | 是          | 查看错误 |

**字段说明**：
- **错误率**：该机构所有规则的总错误率 = 总错误记录数 / 总记录数 × 100%
- **是否建议退回**：
  - 三级/二级：错误率 ≥ 5%
  - 基层：错误率 ≥ 55%
- **操作**：查看该机构的所有错误（按规则分组）

## 等级计算逻辑

从 `SYSTEM_DEPT.HOSPITAL_LEVEL_J` 字段：
```java
String hospitalLevelJ = dept.getHospitalLevelJ();
if ("3".equals(hospitalLevelJ)) {
    return 3; // 三级
} else if ("2".equals(hospitalLevelJ)) {
    return 2; // 二级
} else {
    return 1; // 基层（包括 "1", "9", null 等）
}
```

等级名称：
```java
String hospitalLevelJ = dept.getHospitalLevelJ();
String hospitalGrade = dept.getHospitalGrade(); // 等次：1-甲等, 2-乙等, 3-丙等

if ("3".equals(hospitalLevelJ)) {
    return "三级" + getGradeName(hospitalGrade);
} else if ("2".equals(hospitalLevelJ)) {
    return "二级" + getGradeName(hospitalGrade);
} else {
    return "基层";
}
```

## 错误原因示例

### POST_QC_001 - 参考价格极值检查
```
药品价格（销售金额/销售制剂量）为 1500.00 元，超过参考价格最高价 10.50 元的 100 倍（阈值：1050.00 元）
```

### POST_QC_002 - 使用量异常检查
```
使用量为 50000 支，超过历史平均值 1000 支的 3 倍标准差（阈值：4500 支）
```

## 查看错误弹框

### 规则详情区的"查看错误"
- 显示该机构在该规则下的所有错误数据
- 类似前置质控的错误弹框
- 按错误原因分组展示

### 机构汇总区的"查看错误"
- 显示该机构的所有错误
- 按规则分组展示
- 每个规则下按错误原因分组

## 后端接口设计

### 1. 获取规则错误详情
```
GET /admin/drug/post-qc/rule-error-detail?reportId={reportId}&ruleCode={ruleCode}
返回：PostQcRuleErrorDetailVO
```

### 2. 获取机构汇总列表
```
GET /admin/drug/post-qc/org-summary?reportId={reportId}
返回：PostQcOrgSummaryVO
```

### 3. 获取机构错误详情（按规则分组）
```
GET /admin/drug/post-qc/org-errors-grouped?reportId={reportId}&taskId={taskId}
返回：类似 QcErrorGroupedVO 的结构
```

## 技术实现

### 前端
- 使用 `el-table-v2` 虚拟列表优化性能
- TSX 语法定义列
- 折叠面板展示规则
- 复用 `QcErrorGroupedDialog` 组件（需要适配后置质控）

### 后端
- 从 Redis 读取后置质控结果
- 从 `QcResultDetailDO` 读取错误详情
- 从 `SYSTEM_DEPT` 读取机构等级信息
- 计算错误率和建议退回状态

## 数据流程

1. 后置质控执行时，将结果存入 Redis（按规则维度）
2. 前端请求规则列表，展示折叠面板
3. 展开规则时，加载该规则的错误数据列表
4. 底部机构汇总区，汇总所有规则的错误机构
5. 点击"查看错误"，弹框显示详细错误数据

## 注意事项

1. **性能优化**：使用虚拟列表，支持大数据量（1000+ 条）
2. **数据一致性**：Redis 数据与数据库数据保持一致
3. **用户体验**：默认展开第一条规则，提供搜索和筛选功能
4. **错误原因**：从 `errorMessage` 和 `variableValues` 字段解析生成
