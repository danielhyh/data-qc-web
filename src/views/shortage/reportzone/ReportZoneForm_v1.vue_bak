<template>
  <Dialog :title="dialogTitle" v-model="dialogVisible" width="800px">
    <el-form
      ref="formRef"
      :model="formData"
      :rules="formRules"
      label-width="100px"
      v-loading="formLoading"
    >
      <el-form-item label="ä¸“åŒºç¼–ç " prop="zoneCode">
        <el-input v-model="formData.zoneCode" placeholder="è‡ªåŠ¨ç”Ÿæˆ" :disabled="true" />
      </el-form-item>
      <el-form-item label="ä¸“åŒºåç§°" prop="zoneName">
        <el-input v-model="formData.zoneName" placeholder="è¯·è¾“å…¥ä¸“åŒºåç§°" />
      </el-form-item>
      <el-form-item label="çŠ¶æ€" prop="status">
        <el-radio-group v-model="formData.status">
          <el-radio
            v-for="dict in getIntDictOptions(DICT_TYPE.COMMON_STATUS)"
            :key="dict.value"
            :value="dict.value"
          >
            {{ dict.label }}
          </el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item label="å¡«æŠ¥é€šçŸ¥" prop="noticeContent">
        <Editor
          v-model="formData.noticeContent"
          height="200px"
          placeholder="è¯·è¾“å…¥å¡«æŠ¥é€šçŸ¥å†…å®¹ï¼Œæ”¯æŒå¯Œæ–‡æœ¬æ ¼å¼..."
        />
      </el-form-item>
      <el-form-item label="å¤‡æ³¨è¯´æ˜" prop="remark">
        <el-input
          v-model="formData.remark"
          type="textarea"
          placeholder="è¯·è¾“å…¥å¤‡æ³¨è¯´æ˜"
          :rows="3"
        />
      </el-form-item>
    </el-form>

    <!-- æ—¶é—´é…ç½®å¡ç‰‡ -->
    <el-card shadow="never" class="time-config-card">
      <template #header>
        <div class="card-header">
          <span>å¡«æŠ¥æ—¶é—´é…ç½®</span>
        </div>
      </template>

      <el-form ref="timeFormRef" :model="formData" :rules="timeFormRules" label-width="120px">
        <el-form-item label="æ—¶é—´é™åˆ¶" prop="isTimeRestricted">
          <el-switch
            v-model="formData.isTimeRestricted"
            active-text="å¯ç”¨æ—¶é—´é™åˆ¶"
            inactive-text="ä¸é™åˆ¶æ—¶é—´"
            active-color="#13ce66"
            inactive-color="#ff4949"
          />
          <div class="text-xs text-gray-500 mt-1"> å¯ç”¨åï¼Œåªæœ‰åœ¨æŒ‡å®šæ—¶é—´æ®µå†…æ‰èƒ½è¿›è¡Œå¡«æŠ¥æ“ä½œ </div>
        </el-form-item>

        <div v-if="formData.isTimeRestricted" class="time-config-section">
          <el-form-item label="å¡«æŠ¥æ—¥æœŸ" prop="reportTimeConfig.dayOfWeek">
            <el-select
              v-model="formData.reportTimeConfig.dayOfWeek"
              style="width: 100%"
              placeholder="è¯·é€‰æ‹©å¡«æŠ¥æ—¥æœŸ"
            >
              <el-option
                v-for="day in dayOptions"
                :key="day.value"
                :label="day.label"
                :value="day.value"
              />
            </el-select>
          </el-form-item>

          <el-form-item label="å¡«æŠ¥æ—¶é—´æ®µ">
            <el-row :gutter="12">
              <el-col :span="11">
                <el-form-item prop="reportTimeConfig.startTime">
                  <el-time-picker
                    v-model="startTimeValue"
                    format="HH:mm"
                    value-format="HH:mm"
                    placeholder="å¼€å§‹æ—¶é—´"
                    style="width: 100%"
                  />
                </el-form-item>
              </el-col>
              <el-col :span="2" class="text-center">
                <span class="text-gray-500">è‡³</span>
              </el-col>
              <el-col :span="11">
                <el-form-item prop="reportTimeConfig.endTime">
                  <el-time-picker
                    v-model="endTimeValue"
                    format="HH:mm"
                    value-format="HH:mm"
                    placeholder="ç»“æŸæ—¶é—´"
                    style="width: 100%"
                  />
                </el-form-item>
              </el-col>
            </el-row>
          </el-form-item>

          <el-alert
            :title="getTimeConfigDisplay()"
            type="info"
            :closable="false"
            class="mb-4"
            show-icon
          />
        </div>

        <el-alert
          v-else
          title="ä¸é™åˆ¶å¡«æŠ¥æ—¶é—´ï¼Œç”¨æˆ·å¯åœ¨ä»»ä½•æ—¶é—´è¿›è¡Œæ•°æ®å¡«æŠ¥"
          type="warning"
          :closable="false"
          class="mb-4"
          show-icon
        />
      </el-form>
    </el-card>

    <!-- å¯å¡«æŠ¥æœºæ„é€‰æ‹©å™¨ -->
    <el-card shadow="never" class="org-selector-card">
      <template #header>
        <div class="card-header">
          <span>å¯å¡«æŠ¥æœºæ„</span>
          <div class="header-actions">
            <el-button size="small" @click="openOrgSelector">
              <Icon icon="ep:setting" class="mr-1" />
              é…ç½®æœºæ„
            </el-button>
            <el-button size="small" @click="clearAllOrgs" :disabled="selectedOrgCount === 0">
              <Icon icon="ep:delete" class="mr-1" />
              æ¸…ç©ºé€‰æ‹©
            </el-button>
          </div>
        </div>
      </template>

      <div class="org-summary">
        <div v-if="selectedOrgCount === 0" class="empty-org-state">
          <Icon icon="ep:office-building" class="empty-icon" />
          <p>æš‚æœªé€‰æ‹©ä»»ä½•æœºæ„</p>
          <p class="hint">ç‚¹å‡»"é…ç½®æœºæ„"æŒ‰é’®é€‰æ‹©å¯å¡«æŠ¥çš„åŒ»ç–—æœºæ„</p>
        </div>
        <div v-else class="selected-orgs-list">
          <div class="org-summary-header">
            <el-tag type="success" size="large" class="org-count-tag">
              å·²é€‰æ‹© {{ selectedOrgCount }} ä¸ªæœºæ„
            </el-tag>
            <el-link type="primary" @click="openOrgSelector" class="view-detail">
              é‡æ–°é…ç½® <Icon icon="ep:edit" />
            </el-link>
          </div>

          <!-- ç®€åŒ–çš„æœºæ„åˆ—è¡¨ -->
          <div class="org-list-container">
            <div class="org-grid">
              <div v-for="org in selectedOrgsDetail.slice(0, 12)" :key="org.id" class="org-card">
                <div class="org-header">
                  <span class="org-name" :title="org.name">{{ org.name }}</span>
                  <dict-tag
                    :type="DICT_TYPE.INSTITUTION_LEVEL"
                    :value="org.hospitalLevel"
                    size="small"
                  />
                </div>
              </div>
            </div>

            <!-- å¦‚æœé€‰ä¸­æœºæ„è¶…è¿‡12ä¸ªï¼Œæ˜¾ç¤ºâ€œæ›´å¤šâ€æç¤º -->
            <div v-if="selectedOrgsDetail.length > 12" class="more-orgs-tip">
              <Icon icon="ep:more" />
              è¿˜æœ‰ {{ selectedOrgsDetail.length - 12 }} ä¸ªæœºæ„ï¼Œç‚¹å‡»â€œé‡æ–°é…ç½®â€æŸ¥çœ‹å…¨éƒ¨
            </div>
          </div>
        </div>
      </div>
    </el-card>

    <template #footer>
      <el-button @click="submitForm" type="primary" :disabled="formLoading">ç¡® å®š</el-button>
      <el-button @click="dialogVisible = false">å– æ¶ˆ</el-button>
    </template>
  </Dialog>

  <!-- æœºæ„é€‰æ‹©å™¨å¼¹çª— -->
  <el-dialog
    v-model="orgSelectorVisible"
    title="é€‰æ‹©å¯å¡«æŠ¥æœºæ„"
    width="1200px"
    :close-on-click-modal="false"
  >
    <div class="org-selector-container">
      <el-row :gutter="12">
        <!-- å·¦ä¾§ï¼šåœ°åŒºæ ‘ -->
        <el-col :span="10">
          <el-card shadow="never" class="selector-card">
            <template #header>
              <div class="card-header">
                <span>é€‰æ‹©åœ°åŒº</span>
              </div>
            </template>
            <el-tree
              ref="areaTreeRef"
              :data="areaTreeData"
              :props="areaTreeProps"
              node-key="code"
              highlight-current
              default-expand-all
              @node-click="handleAreaNodeClick"
            >
              <template #default="{ node, data }">
                <span class="tree-node">
                  <Icon :icon="getAreaIcon(data.level)" class="node-icon" />
                  <span class="node-label">
                    {{ node.label }}
                    <span v-if="data.orgCount !== undefined" class="org-count"
                      >({{ data.orgCount }})</span
                    >
                  </span>
                </span>
              </template>
            </el-tree>
          </el-card>
        </el-col>

        <!-- å³ä¾§ï¼šæœºæ„æ ‘ -->
        <el-col :span="14">
          <el-card shadow="never" class="selector-card">
            <template #header>
              <div class="card-header">
                <span>é€‰æ‹©æœºæ„</span>
                <div class="header-actions">
                  å…¨é€‰/å…¨ä¸é€‰:
                  <el-switch
                    v-model="treeNodeAll"
                    active-text="æ˜¯"
                    inactive-text="å¦"
                    inline-prompt
                    @change="handleCheckedTreeNodeAll()"
                    :disabled="!selectedArea"
                  />
                  å…¨éƒ¨å±•å¼€/æŠ˜å :
                  <el-switch
                    v-model="deptExpand"
                    active-text="å±•å¼€"
                    inactive-text="æŠ˜å "
                    inline-prompt
                    @change="handleCheckedTreeExpand"
                    :disabled="!selectedArea"
                  />
                  çˆ¶å­è”åŠ¨:
                  <el-switch
                    v-model="checkStrictly"
                    active-text="æ˜¯"
                    inactive-text="å¦"
                    inline-prompt
                    :disabled="!selectedArea"
                  />
                </div>
              </div>
            </template>

            <!-- æœºæ„ç­‰çº§å¤šé€‰æ¡† -->
            <div v-if="selectedArea" class="institution-level-filter">
              <span class="filter-label">æœºæ„ç­‰çº§ç­›é€‰ï¼š</span>
              <el-checkbox-group
                v-model="selectedInstitutionLevels"
                @change="handleInstitutionLevelChange"
              >
                <el-checkbox
                  v-for="dict in getIntDictOptions(DICT_TYPE.INSTITUTION_LEVEL)"
                  :key="dict.value"
                  :value="dict.value"
                  border
                  size="small"
                  class="level-checkbox"
                >
                  {{ dict.label }}
                </el-checkbox>
              </el-checkbox-group>
            </div>

            <div v-if="!selectedArea" class="empty-state">
              <Icon icon="ep:pointer" class="empty-icon" />
              <p>è¯·å…ˆé€‰æ‹©å·¦ä¾§åœ°åŒº</p>
            </div>

            <el-tree
              v-else
              ref="treeRef"
              :check-strictly="!checkStrictly"
              :data="filteredDeptOptions"
              :props="defaultProps"
              :default-expand-all="deptExpand"
              empty-text="è¯¥åœ°åŒºæš‚æ— æœºæ„"
              node-key="id"
              show-checkbox
            >
              <template #default="{ node, data }">
                <div class="dept-node">
                  <span>{{ node.label }}</span>
                  <dict-tag
                    :type="DICT_TYPE.INSTITUTION_LEVEL"
                    :value="data.hospitalLevel"
                    class="ml-2"
                  />
                </div>
              </template>
            </el-tree>
          </el-card>
        </el-col>
      </el-row>
    </div>

    <template #footer>
      <el-button @click="confirmOrgSelection" type="primary">ç¡®å®šé€‰æ‹©</el-button>
      <el-button @click="orgSelectorVisible = false">å–æ¶ˆ</el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { DICT_TYPE, getIntDictOptions } from '@/utils/dict'
import { ReportZoneApi } from '@/api/shortage'
import type { ReportZoneVO } from '@/api/shortage'
import { Editor } from '@/components/Editor'
import { Icon } from '@/components/Icon'
import * as DeptApi from '@/api/system/dept'
import * as RegionsApi from '@/api/system/regions'
import { defaultProps, handleTree } from '@/utils/tree'

/** çŸ­ç¼ºè¯å“å¡«æŠ¥ä¸“åŒº è¡¨å• */
defineOptions({ name: 'ReportZoneForm' })

const message = useMessage() // æ¶ˆæ¯å¼¹çª—

const dialogVisible = ref(false) // å¼¹çª—çš„æ˜¯å¦å±•ç¤º
const dialogTitle = ref('') // å¼¹çª—çš„æ ‡é¢˜
const formLoading = ref(false) // è¡¨å•çš„åŠ è½½ä¸­ï¼š1ï¼‰ä¿®æ”¹æ—¶çš„æ•°æ®åŠ è½½ï¼›2ï¼‰æäº¤çš„æŒ‰é’®ç¦ç”¨
const formType = ref('') // è¡¨å•çš„ç±»å‹ï¼šcreate - æ–°å¢ï¼›update - ä¿®æ”¹
const formData = ref({
  id: undefined,
  zoneName: '',
  zoneCode: '',
  noticeContent: '',
  status: 0, // é»˜è®¤å¼€å¯ï¼ˆå¯ç”¨çŠ¶æ€ï¼‰
  remark: '',
  reportableOrgs: '',
  // æ—¶é—´é…ç½®ç›¸å…³å­—æ®µ
  isTimeRestricted: true, // æ˜¯å¦å¯ç”¨æ—¶é—´é™åˆ¶
  reportTimeConfig: {
    dayOfWeek: 5, // é»˜è®¤å‘¨äº”
    startTime: '12:00',
    endTime: '18:00'
  }
})

// æ—¥æœŸé€‰é¡¹å¸¸é‡
const dayOptions = [
  { value: 1, label: 'å‘¨ä¸€' },
  { value: 2, label: 'å‘¨äºŒ' },
  { value: 3, label: 'å‘¨ä¸‰' },
  { value: 4, label: 'å‘¨å››' },
  { value: 5, label: 'å‘¨äº”' },
  { value: 6, label: 'å‘¨å…­' },
  { value: 7, label: 'å‘¨æ—¥' }
]

// æ—¶é—´é€‰æ‹©å™¨çš„åŒå‘ç»‘å®š
const startTimeValue = computed({
  get: () => formData.value.reportTimeConfig.startTime,
  set: (val: string) => {
    if (val) {
      formData.value.reportTimeConfig.startTime = val
    }
  }
})

const endTimeValue = computed({
  get: () => formData.value.reportTimeConfig.endTime,
  set: (val: string) => {
    if (val) {
      formData.value.reportTimeConfig.endTime = val
    }
  }
})

// è·å–æ—¶é—´é…ç½®æ˜¾ç¤ºæ–‡æœ¬
const getTimeConfigDisplay = () => {
  if (!formData.value.isTimeRestricted) return ''

  const dayLabel =
    dayOptions.find((d) => d.value === formData.value.reportTimeConfig.dayOfWeek)?.label || ''
  const { startTime, endTime } = formData.value.reportTimeConfig

  return `å¡«æŠ¥æ—¶é—´è®¾ç½®ï¼šæ¯${dayLabel} ${startTime} - ${endTime}`
}

// éƒ¨é—¨æ ‘ç›¸å…³
const deptOptions = ref<any[]>([]) // åŸå§‹éƒ¨é—¨æ ‘å½¢ç»“æ„
const filteredDeptOptions = ref<any[]>([]) // è¿‡æ»¤åçš„éƒ¨é—¨æ ‘å½¢ç»“æ„
const deptExpand = ref(true) // å±•å¼€/æŠ˜å 
const treeRef = ref() // éƒ¨é—¨æ ‘ç»„ä»¶ Ref
const treeNodeAll = ref(false) // å…¨é€‰/å…¨ä¸é€‰
const checkStrictly = ref(true) // æ˜¯å¦ä¸¥æ ¼æ¨¡å¼ï¼Œå³çˆ¶å­ä¸å…³è”

// åœ°åŒºæ ‘ç›¸å…³
const areaTreeRef = ref() // åœ°åŒºæ ‘ç»„ä»¶ Ref
const areaTreeData = ref<any[]>([]) // åœ°åŒºæ ‘å½¢ç»“æ„
const selectedArea = ref<any>(null) // é€‰ä¸­çš„åœ°åŒº

const areaTreeProps = {
  label: 'name',
  children: 'children'
}

// æœºæ„ç­‰çº§ç­›é€‰ç›¸å…³
const selectedInstitutionLevels = ref<number[]>([]) // é€‰ä¸­çš„æœºæ„ç­‰çº§

// æœºæ„é€‰æ‹©å™¨å¼¹çª—ç›¸å…³
const orgSelectorVisible = ref(false) // æœºæ„é€‰æ‹©å™¨å¼¹çª—æ˜¯å¦æ˜¾ç¤º
const selectedOrgIds = ref<number[]>([]) // å½“å‰é€‰ä¸­çš„æœºæ„IDåˆ—è¡¨

// è®¡ç®—å±æ€§ï¼šå·²é€‰æ‹©æœºæ„æ•°é‡
const selectedOrgCount = computed(() => selectedOrgIds.value.length)

// ç”¨äºå­˜å‚¨å·²é€‰ä¸­æœºæ„çš„è¯¦ç»†ä¿¡æ¯ï¼ˆç”¨äºç¼–è¾‘çŠ¶æ€ä¸‹çš„å›æ˜¾ï¼‰
const selectedOrgsCache = ref<any[]>([])

// è®¡ç®—å±æ€§ï¼šé€‰ä¸­çš„æœºæ„è¯¦æƒ…åˆ—è¡¨
const selectedOrgsDetail = computed(() => {
  if (selectedOrgIds.value.length === 0) return []

  // ä»æ ‘å½¢æ•°æ®ä¸­é€’å½’æŸ¥æ‰¾é€‰ä¸­çš„æœºæ„è¯¦æƒ…
  const findOrgInTree = (nodes: any[], targetIds: number[]): any[] => {
    const result: any[] = []

    for (const node of nodes) {
      if (targetIds.includes(node.id)) {
        result.push({
          id: node.id,
          name: node.name,
          hospitalLevel: node.hospitalLevel,
          address: node.address || '',
          contactPerson: node.contactPerson || '',
          contactPhone: node.contactPhone || ''
        })
      }

      // é€’å½’æŸ¥æ‰¾å­èŠ‚ç‚¹
      if (node.children && node.children.length > 0) {
        const childResults = findOrgInTree(node.children, targetIds)
        result.push(...childResults)
      }
    }

    return result
  }

  // ä¼˜å…ˆä»deptOptionsä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°åˆ™ä½¿ç”¨ç¼“å­˜æ•°æ®
  const foundOrgs = findOrgInTree(deptOptions.value, selectedOrgIds.value)
  if (foundOrgs.length > 0) {
    return foundOrgs
  }

  // å¦‚æœæ²¡æœ‰åœ¨å½“å‰æ ‘ä¸­æ‰¾åˆ°ï¼Œä½¿ç”¨ç¼“å­˜çš„æœºæ„ä¿¡æ¯ï¼ˆç¼–è¾‘çŠ¶æ€ä¸‹çš„å›æ˜¾ï¼‰
  return selectedOrgsCache.value.filter((org) => selectedOrgIds.value.includes(org.id))
})

const formRules = reactive({
  zoneName: [{ required: true, message: 'ä¸“åŒºåç§°ä¸èƒ½ä¸ºç©º', trigger: 'blur' }],
  zoneCode: [{ required: true, message: 'ä¸“åŒºç¼–ç ä¸èƒ½ä¸ºç©º', trigger: 'blur' }],
  status: [{ required: true, message: 'è¯·é€‰æ‹©çŠ¶æ€', trigger: 'change' }]
})

// æ—¶é—´é…ç½®éªŒè¯è§„åˆ™
const timeFormRules = reactive({
  'reportTimeConfig.dayOfWeek': [{ required: true, message: 'è¯·é€‰æ‹©å¡«æŠ¥æ—¥æœŸ', trigger: 'change' }],
  'reportTimeConfig.startTime': [{ required: true, message: 'è¯·é€‰æ‹©å¼€å§‹æ—¶é—´', trigger: 'change' }],
  'reportTimeConfig.endTime': [{ required: true, message: 'è¯·é€‰æ‹©ç»“æŸæ—¶é—´', trigger: 'change' }]
})

const formRef = ref() // è¡¨å• Ref
const timeFormRef = ref() // æ—¶é—´é…ç½®è¡¨å• Ref

// è·å–åŒºåŸŸå›¾æ ‡
const getAreaIcon = (level: number) => {
  const icons = {
    1: 'ep:location', // çœ
    2: 'ep:map-location', // å¸‚
    3: 'ep:place' // åŒº
  }
  return icons[level] || 'ep:location'
}

// å¤„ç†åœ°åŒºèŠ‚ç‚¹ç‚¹å‡»
const handleAreaNodeClick = async (data: any) => {
  selectedArea.value = data

  // åˆ‡æ¢åœ°åŒºæ—¶ï¼Œé‡ç½®ç›¸å…³çŠ¶æ€
  selectedInstitutionLevels.value = []
  treeNodeAll.value = false

  // åŠ è½½è¯¥åœ°åŒºçš„æœºæ„æ•°æ®
  await loadDeptData(data.code)

  // åœ¨æ•°æ®åŠ è½½å®Œæˆåï¼Œè®¾ç½®å·²é€‰ä¸­çš„æœºæ„çŠ¶æ€
  setTimeout(() => {
    if (selectedOrgIds.value.length > 0 && treeRef.value) {
      treeRef.value.setCheckedKeys(selectedOrgIds.value)
    }
  }, 200)
}

// åŠ è½½æœºæ„æ•°æ®
const loadDeptData = async (areaCode: string) => {
  try {
    // æ ¹æ®åœ°åŒºä»£ç æŸ¥è¯¢è¯¥åœ°åŒºä¸‹çš„æœºæ„æ•°æ®
    const data = await DeptApi.getDeptPage({ areaCode, pageSize: 1000 })
    deptOptions.value = handleTree(data.list || data)

    // åº”ç”¨æœºæ„ç­‰çº§ç­›é€‰
    applyInstitutionLevelFilter()
  } catch (error) {
    console.error('åŠ è½½æœºæ„æ•°æ®å¤±è´¥:', error)
    deptOptions.value = []
    filteredDeptOptions.value = []
  }
}

// å¤„ç†æœºæ„ç­‰çº§å˜åŒ–
const handleInstitutionLevelChange = () => {
  applyInstitutionLevelFilter()
}

// åº”ç”¨æœºæ„ç­‰çº§ç­›é€‰
const applyInstitutionLevelFilter = () => {
  if (selectedInstitutionLevels.value.length === 0) {
    // å¦‚æœæ²¡æœ‰é€‰æ‹©ç­‰çº§ï¼Œæ˜¾ç¤ºæ‰€æœ‰æœºæ„
    filteredDeptOptions.value = deptOptions.value
  } else {
    // ç­›é€‰æŒ‡å®šç­‰çº§çš„æœºæ„
    filteredDeptOptions.value = filterTreeByLevel(
      deptOptions.value,
      selectedInstitutionLevels.value
    )
  }

  // ç­›é€‰åé‡æ–°è®¾ç½®é€‰ä¸­çŠ¶æ€
  nextTick(() => {
    if (selectedOrgIds.value.length > 0 && treeRef.value) {
      treeRef.value.setCheckedKeys(selectedOrgIds.value)
    }
  })
}

// é€’å½’ç­›é€‰æ ‘èŠ‚ç‚¹
const filterTreeByLevel = (nodes: any[], levels: number[]): any[] => {
  const levelStrings = levels.map((l) => l.toString()) // è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ•°ç»„è¿›è¡Œæ¯”è¾ƒ

  return nodes
    .filter((node) => {
      // å¦‚æœå½“å‰èŠ‚ç‚¹åŒ¹é…ç­‰çº§æ¡ä»¶ï¼Œä¿ç•™
      const nodeLevel = node.hospitalLevel
      if (nodeLevel !== undefined && nodeLevel !== null) {
        // æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²ç±»å‹çš„hospitalLevelæ¯”è¾ƒ
        const nodeLevelStr = nodeLevel.toString()
        if (levels.includes(nodeLevel) || levelStrings.includes(nodeLevelStr)) {
          return true
        }
      }

      // å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œé€’å½’ç­›é€‰å­èŠ‚ç‚¹
      if (node.children && node.children.length > 0) {
        const filteredChildren = filterTreeByLevel(node.children, levels)
        if (filteredChildren.length > 0) {
          // å¦‚æœæœ‰ç¬¦åˆæ¡ä»¶çš„å­èŠ‚ç‚¹ï¼Œä¿ç•™å½“å‰èŠ‚ç‚¹ä½†æ›´æ–°å­èŠ‚ç‚¹
          return { ...node, children: filteredChildren }
        }
      }

      return false
    })
    .map((node) => {
      if (node.children && node.children.length > 0) {
        return { ...node, children: filterTreeByLevel(node.children, levels) }
      }
      return node
    })
}

// æ ¹æ®æœºæ„IDåˆ—è¡¨è·å–æœºæ„è¯¦æƒ…ï¼ˆç”¨äºç¼–è¾‘çŠ¶æ€ä¸‹çš„å›æ˜¾ï¼‰
const loadOrgDetailsByIds = async (orgIds: number[]) => {
  if (!orgIds || orgIds.length === 0) {
    selectedOrgsCache.value = []
    return
  }

  try {
    // æ‰¹é‡æŸ¥è¯¢æœºæ„è¯¦æƒ…
    const promises = orgIds.map(async (id) => {
      try {
        const orgDetail = await DeptApi.getDept(id)
        return {
          id: orgDetail.id,
          name: orgDetail.name,
          hospitalLevel: orgDetail.hospitalLevel,
          address: orgDetail.address || '',
          contactPerson: orgDetail.contactPerson || '',
          contactPhone: orgDetail.contactPhone || ''
        }
      } catch (error) {
        console.warn(`è·å–æœºæ„ ${id} è¯¦æƒ…å¤±è´¥:`, error)
        return {
          id,
          name: `æœºæ„ID: ${id}`,
          hospitalLevel: '',
          address: '',
          contactPerson: '',
          contactPhone: ''
        }
      }
    })

    const orgDetails = await Promise.all(promises)
    selectedOrgsCache.value = orgDetails.filter((org) => org !== null)
  } catch (error) {
    console.error('æ‰¹é‡è·å–æœºæ„è¯¦æƒ…å¤±è´¥:', error)
    selectedOrgsCache.value = []
  }
}

// åˆå§‹åŒ–åœ°åŒºæ ‘æ•°æ®
const initAreaTree = async () => {
  try {
    // è°ƒç”¨çœŸå®çš„åœ°åŒºæ ‘API
    const data = await RegionsApi.RegionsApi.getRegionsTreeWithOrgCount()
    areaTreeData.value = data || []
  } catch (error) {
    console.error('åˆå§‹åŒ–åœ°åŒºæ ‘å¤±è´¥:', error)
    areaTreeData.value = []
  }
}

// åˆ é™¤æ—§çš„ç¤ºä¾‹æ•°æ®è·å–æ–¹æ³•
// const getAreaTreeData = async () => { ... }

// æ‰“å¼€æœºæ„é€‰æ‹©å™¨å¼¹çª—
const openOrgSelector = async () => {
  orgSelectorVisible.value = true

  // åˆå§‹åŒ–åœ°åŒºæ ‘ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰
  if (areaTreeData.value.length === 0) {
    await initAreaTree()
  }

  // é»˜è®¤é€‰æ‹©é¡¶çº§èŠ‚ç‚¹(610000)å¹¶åŠ è½½æ‰€æœ‰æœºæ„æ•°æ®
  if (areaTreeData.value.length > 0) {
    // æŸ¥æ‰¾é™•è¥¿çœèŠ‚ç‚¹ (610000)
    const findTopLevelNode = (nodes: any[]): any => {
      for (const node of nodes) {
        if (node.code === '610000') {
          return node
        }
        if (node.children && node.children.length > 0) {
          const found = findTopLevelNode(node.children)
          if (found) return found
        }
      }
      return nodes[0] // å¦‚æœæ‰¾ä¸åˆ°610000ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    }

    const topLevelNode = findTopLevelNode(areaTreeData.value)
    if (topLevelNode) {
      selectedArea.value = topLevelNode
      // åŠ è½½è¯¥åœ°åŒºçš„æœºæ„æ•°æ®
      await loadDeptData(topLevelNode.code)

      // åœ¨åœ°åŒºæ ‘ä¸­é«˜äº®é€‰ä¸­çš„èŠ‚ç‚¹
      nextTick(() => {
        if (areaTreeRef.value) {
          areaTreeRef.value.setCurrentKey(topLevelNode.code)
        }
      })
    }
  }

  // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„æœºæ„ï¼Œéœ€è¦åœ¨æ ‘ç»„ä»¶ä¸­è®¾ç½®é€‰ä¸­çŠ¶æ€
  // ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿç¡®ä¿æ ‘ç»„ä»¶å®Œå…¨æ¸²æŸ“
  setTimeout(() => {
    if (selectedOrgIds.value.length > 0 && treeRef.value) {
      // å…ˆæ¸…é™¤å·²æœ‰çš„é€‰ä¸­çŠ¶æ€
      treeRef.value.setCheckedKeys([])
      // å†è®¾ç½®æ–°çš„é€‰ä¸­çŠ¶æ€
      treeRef.value.setCheckedKeys(selectedOrgIds.value)
      console.log('è®¾ç½®é€‰ä¸­æœºæ„ID:', selectedOrgIds.value)
    }
  }, 800) // å¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
}

// æ¸…ç©ºæ‰€æœ‰æœºæ„é€‰æ‹©
const clearAllOrgs = () => {
  selectedOrgIds.value = []
  treeRef.value?.setCheckedNodes([])
  treeNodeAll.value = false
}

// ç¡®è®¤æœºæ„é€‰æ‹©
const confirmOrgSelection = () => {
  // è·å–å½“å‰é€‰ä¸­çš„æœºæ„IDåˆ—è¡¨
  const checkedKeys = treeRef.value?.getCheckedKeys(false) || []
  selectedOrgIds.value = [...checkedKeys]

  // å…³é—­å¼¹çª—
  orgSelectorVisible.value = false

  // æ˜¾ç¤ºé€‰æ‹©ç»“æœæç¤º
  if (checkedKeys.length > 0) {
    message.success(`æˆåŠŸé€‰æ‹© ${checkedKeys.length} ä¸ªæœºæ„`)
  }
}
const generateZoneCode = async () => {
  const maxRetries = 5
  let attempt = 0

  while (attempt < maxRetries) {
    try {
      // è·å–å½“å‰æ—¶é—´ä¿¡æ¯
      const now = new Date()
      const year = now.getFullYear().toString().slice(-2)
      const month = String(now.getMonth() + 1).padStart(2, '0')
      const day = String(now.getDate()).padStart(2, '0')
      const hour = String(now.getHours()).padStart(2, '0')
      const minute = String(now.getMinutes()).padStart(2, '0')

      // ç”Ÿæˆéšæœºæ•°ï¼ˆ3ä½ï¼‰
      const randomNum = Math.floor(Math.random() * 1000)
        .toString()
        .padStart(3, '0')

      // ç»„åˆç¼–ç ï¼šZONE_å¹´æœˆæ—¥æ—¶åˆ†_éšæœºæ•°
      const baseCode = `ZONE_${year}${month}${day}${hour}${minute}_${randomNum}`

      // æ£€æŸ¥ç¼–ç æ˜¯å¦å·²å­˜åœ¨
      const existingData = await ReportZoneApi.getPage({
        pageNo: 1,
        pageSize: 1,
        zoneCode: baseCode
      })

      // å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›æ­¤ç¼–ç 
      if (!existingData.list || existingData.list.length === 0) {
        return baseCode
      }

      // å¦‚æœå­˜åœ¨ï¼Œå¢åŠ å°è¯•æ¬¡æ•°ç»§ç»­ç”Ÿæˆ
      attempt++

      // æ·»åŠ çŸ­æš‚å»¶æ—¶é¿å…è¿ç»­ç”Ÿæˆç›¸åŒæ—¶é—´æˆ³
      await new Promise((resolve) => setTimeout(resolve, 100))
    } catch (error) {
      console.warn(`ç”Ÿæˆä¸“åŒºç¼–ç å¤±è´¥ï¼Œå°è¯•æ¬¡æ•°ï¼š${attempt + 1}`, error)
      attempt++

      // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥æ—¶ï¼Œä½¿ç”¨çº¯æ—¶é—´æˆ³ + UUID å4ä½
      if (attempt === maxRetries) {
        const timestamp = Date.now().toString()
        const uuid = crypto.randomUUID().replace(/-/g, '').slice(-4).toUpperCase()
        return `ZONE_${timestamp}_${uuid}`
      }
    }
  }

  // å…œåº•æ–¹æ¡ˆï¼šä½¿ç”¨å®Œæ•´æ—¶é—´æˆ³
  return `ZONE_${Date.now()}_${Math.random().toString(36).slice(-4).toUpperCase()}`
}

/** æ‰“å¼€å¼¹çª— */
const open = async (type: string, id?: number) => {
  dialogVisible.value = true
  dialogTitle.value = type === 'create' ? 'æ–°å¢ä¸“åŒº' : 'ç¼–è¾‘ä¸“åŒº'
  formType.value = type
  resetForm()

  // åˆå§‹åŒ–åœ°åŒºæ ‘æ•°æ®
  await initAreaTree()

  // ä¿®æ”¹æ—¶ï¼Œè®¾ç½®æ•°æ®
  if (id) {
    formLoading.value = true
    try {
      const data = await ReportZoneApi.get(id)
      Object.assign(formData.value, data)

      // å›æ˜¾æ—¶é—´é…ç½®æ•°æ®
      if (data.reportTimeConfig) {
        formData.value.reportTimeConfig = {
          dayOfWeek: data.reportTimeConfig.dayOfWeek,
          startTime: data.reportTimeConfig.startTime,
          endTime: data.reportTimeConfig.endTime
        }
      } else {
        // ä½¿ç”¨é»˜è®¤é…ç½®
        formData.value.reportTimeConfig = {
          dayOfWeek: 5,
          startTime: '12:00',
          endTime: '18:00'
        }
      }

      // å¦‚æœæœ‰æ—¶é—´é™åˆ¶å­—æ®µåˆ™å›æ˜¾ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
      formData.value.isTimeRestricted = data.isTimeRestricted ?? true

      // å¦‚æœæœ‰é€‰æ‹©çš„æœºæ„ï¼Œè®¾ç½®åˆ°selectedOrgIdsä¸­å¹¶åŠ è½½è¯¦æƒ…
      if (data.reportableOrgs) {
        const deptIds = data.reportableOrgs
          .split(',')
          .map((id) => parseInt(id.trim()))
          .filter((id) => !isNaN(id))
        selectedOrgIds.value = [...deptIds]
        // åŠ è½½é€‰ä¸­æœºæ„çš„è¯¦ç»†ä¿¡æ¯ç”¨äºå›æ˜¾
        await loadOrgDetailsByIds(deptIds)
      }
    } finally {
      formLoading.value = false
    }
  } else {
    // æ–°å¢æ—¶è‡ªåŠ¨ç”Ÿæˆä¸“åŒºç¼–ç 
    formData.value.zoneCode = await generateZoneCode()
  }
}

defineExpose({ open }) // æä¾› open æ–¹æ³•ï¼Œç”¨äºæ‰“å¼€å¼¹çª—

/** æäº¤è¡¨å• */
const emit = defineEmits(['success']) // å®šä¹‰ success äº‹ä»¶ï¼Œç”¨äºæ“ä½œæˆåŠŸåçš„å›è°ƒ

const submitForm = async () => {
  // æ ¡éªŒä¸»è¡¨å•
  if (!formRef.value) return
  const valid = await formRef.value.validate().catch(() => {})
  if (!valid) return

  // å¦‚æœå¯ç”¨æ—¶é—´é™åˆ¶ï¼Œéœ€è¦éªŒè¯æ—¶é—´é…ç½®
  if (formData.value.isTimeRestricted) {
    if (!timeFormRef.value) return
    const timeValid = await timeFormRef.value.validate().catch(() => {})
    if (!timeValid) return

    // éªŒè¯æ—¶é—´èŒƒå›´
    const start = formData.value.reportTimeConfig.startTime
    const end = formData.value.reportTimeConfig.endTime
    if (start >= end) {
      message.error('å¼€å§‹æ—¶é—´ä¸èƒ½æ™šäºæˆ–ç­‰äºç»“æŸæ—¶é—´')
      return
    }
  }

  // æäº¤è¯·æ±‚
  formLoading.value = true
  try {
    const data = { ...formData.value } as ReportZoneVO

    // å¤„ç†å¯å¡«æŠ¥æœºæ„IDåˆ—è¡¨ - ä½¿ç”¨selectedOrgIdsè€Œä¸æ˜¯ä»æ ‘ç»„ä»¶è·å–
    data.reportableOrgs = selectedOrgIds.value.join(',')

    if (formType.value === 'create') {
      await ReportZoneApi.create(data)
      message.success('åˆ›å»ºæˆåŠŸ')
    } else {
      await ReportZoneApi.update(data)
      message.success('æ›´æ–°æˆåŠŸ')
    }
    dialogVisible.value = false
    // å‘é€æ“ä½œæˆåŠŸçš„äº‹ä»¶
    emit('success')
  } finally {
    formLoading.value = false
  }
}

/** é‡ç½®è¡¨å• */
const resetForm = () => {
  formData.value = {
    id: undefined,
    zoneName: '',
    zoneCode: '',
    noticeContent: getDefaultNoticeContent(),
    status: 0, // é»˜è®¤å¼€å¯ï¼ˆå¯ç”¨çŠ¶æ€ï¼‰
    remark: '',
    reportableOrgs: '',
    // é‡ç½®æ—¶é—´é…ç½®ç›¸å…³å­—æ®µ
    isTimeRestricted: true, // é»˜è®¤å¯ç”¨æ—¶é—´é™åˆ¶
    reportTimeConfig: {
      dayOfWeek: 5, // é»˜è®¤å‘¨äº”
      startTime: '12:00',
      endTime: '18:00'
    }
  }

  // é‡ç½®åœ°åŒºå’Œæœºæ„ç›¸å…³çŠ¶æ€
  selectedArea.value = null
  selectedInstitutionLevels.value = []
  selectedOrgIds.value = []
  selectedOrgsCache.value = [] // æ¸…ç©ºç¼“å­˜
  deptOptions.value = []
  filteredDeptOptions.value = []

  // é‡ç½®æœºæ„é€‰æ‹©å™¨å¼¹çª—çŠ¶æ€
  orgSelectorVisible.value = false

  // é‡ç½®éƒ¨é—¨æ ‘çŠ¶æ€
  treeNodeAll.value = false
  deptExpand.value = true
  checkStrictly.value = true
  treeRef.value?.setCheckedNodes([])

  formRef.value?.resetFields()
  timeFormRef.value?.resetFields() // é‡ç½®æ—¶é—´é…ç½®è¡¨å•éªŒè¯çŠ¶æ€
}

// è·å–é»˜è®¤é€šçŸ¥å†…å®¹æ¨¡æ¿
const getDefaultNoticeContent = (): string => {
  return `<div>
    <h3>ğŸ“¢ å¡«æŠ¥é€šçŸ¥</h3>
    <p>å„åŒ»ç–—æœºæ„è¯·æ³¨æ„ï¼š</p>
    <ol>
      <li><strong>å¡«æŠ¥æ—¶é—´</strong>ï¼šæ¯å‘¨äº”12:00-18:00</li>
      <li><strong>å¡«æŠ¥èŒƒå›´</strong>ï¼šæœ¬å‘¨å…­è‡³æœ¬å‘¨äº”ä¸­åˆ12:00çš„æ•°æ®</li>
      <li><strong>æ•°æ®è¦æ±‚</strong>ï¼šæŒ‰æœ€å°å‰‚é‡å•ä½å¡«å†™ï¼Œæ•°æ®çœŸå®å‡†ç¡®</li>
      <li><strong>è”ç³»æ–¹å¼</strong>ï¼šå¦‚æœ‰ç–‘é—®è¯·è”ç³»è´¨æ§ä¸­å¿ƒ</li>
    </ol>
    <p style="color: #E74C3C;">è¯·åŠ¡å¿…åœ¨è§„å®šæ—¶é—´å†…å®Œæˆå¡«æŠ¥ï¼Œé€¾æœŸç³»ç»Ÿå°†è‡ªåŠ¨å…³é—­ã€‚</p>
  </div>`
}

/** å…¨é€‰/å…¨ä¸é€‰ */
const handleCheckedTreeNodeAll = () => {
  if (!selectedArea.value) return
  treeRef.value.setCheckedNodes(treeNodeAll.value ? filteredDeptOptions.value : [])
}

/** å±•å¼€/æŠ˜å å…¨éƒ¨ */
const handleCheckedTreeExpand = () => {
  const nodes = treeRef.value?.store.nodesMap
  for (let node in nodes) {
    if (nodes[node].expanded === deptExpand.value) {
      continue
    }
    nodes[node].expanded = deptExpand.value
  }
}
</script>

<style scoped lang="scss">
// æ—¶é—´é…ç½®å¡ç‰‡æ ·å¼
.time-config-card {
  margin-bottom: 20px;

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
  }

  .time-config-section {
    border-left: 3px solid #409eff;
    padding-left: 16px;
    margin-left: 8px;
    background-color: #f8f9fa;
    padding: 16px;
    border-radius: 4px;
    margin-bottom: 16px;
  }

  .text-center {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .text-xs {
    font-size: 12px;
  }

  .text-gray-500 {
    color: #909399;
  }

  .mt-1 {
    margin-top: 4px;
  }

  .mb-4 {
    margin-bottom: 16px;
  }
}

// æœºæ„é€‰æ‹©å™¨å¡ç‰‡æ ·å¼
.org-selector-card {
  margin-bottom: 20px;

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;

    .header-actions {
      display: flex;
      gap: 8px;
    }
  }

  .org-summary {
    min-height: 120px;

    .empty-org-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--el-text-color-secondary);
      padding: 40px 0;

      .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        color: var(--el-border-color-darker);
      }

      p {
        margin: 8px 0;

        &.hint {
          font-size: 14px;
          color: var(--el-text-color-placeholder);
        }
      }
    }

    .selected-orgs-list {
      .org-summary-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--el-border-color-lighter);

        .org-count-tag {
          padding: 12px 16px;
          font-size: 16px;
        }

        .view-detail {
          font-size: 14px;
          text-decoration: none;

          &:hover {
            text-decoration: underline;
          }
        }
      }

      .org-list-container {
        max-height: 300px;
        overflow-y: auto;

        .org-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 8px;
          margin-bottom: 12px;
        }

        .org-card {
          padding: 8px 12px;
          background: var(--el-bg-color-page);
          border: 1px solid var(--el-border-color-lighter);
          border-radius: 4px;
          transition: all 0.2s ease;
          min-height: 40px;
          display: flex;
          align-items: center;

          &:hover {
            border-color: var(--el-color-primary-light-5);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
          }

          .org-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;

            .org-name {
              font-size: 14px;
              color: var(--el-text-color-primary);
              flex: 1;
              margin-right: 8px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }
          }
        }

        .more-orgs-tip {
          text-align: center;
          padding: 12px;
          color: var(--el-text-color-secondary);
          font-size: 13px;
          background: var(--el-bg-color);
          border: 1px dashed var(--el-border-color);
          border-radius: 4px;

          .ep-more {
            margin-right: 4px;
          }
        }
      }
    }
  }
}

// æœºæ„é€‰æ‹©å™¨å¼¹çª—å†…çš„æ ·å¼
.org-selector-container {
  .selector-card {
    height: 500px;
    display: flex;
    flex-direction: column;

    :deep(.el-card__header) {
      padding: 12px 16px;
      border-bottom: 1px solid var(--el-border-color-lighter);
    }

    :deep(.el-card__body) {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;

    .header-actions {
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 14px;
    }
  }

  .tree-node {
    display: flex;
    align-items: center;
    flex: 1;

    .node-icon {
      margin-right: 6px;
      color: var(--el-color-primary);
    }

    .node-label {
      display: flex;
      align-items: center;
      gap: 4px;

      .org-count {
        color: var(--el-text-color-secondary);
        font-size: 12px;
        font-weight: normal;
      }
    }
  }

  .institution-level-filter {
    padding: 12px 0;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--el-border-color-lighter);

    .filter-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--el-text-color-regular);
      font-weight: 500;
    }

    :deep(.el-checkbox-group) {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;

      .el-checkbox.is-bordered {
        margin-right: 0;
        border-radius: 4px;

        &.is-checked {
          border-color: var(--el-color-primary);
          background-color: var(--el-color-primary-light-9);
        }
      }
    }
  }

  .dept-node {
    display: flex;
    align-items: center;
    width: 100%;
    gap: 8px;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: var(--el-text-color-secondary);

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--el-border-color-darker);
    }

    p {
      margin: 0;
      font-size: 14px;
    }
  }
}
</style>
